# ðŸ“š Story Plot Analysis & Sentiment Modeling Workflow

# Step 1: Load Required Libraries and Raw Data
setwd("/Users/trentyu/Desktop/Messy Data Machine Learning/Assignment 5")
library(tidyverse)
library(tidytext)

plots <- read_lines("data/plots") %>% tibble(text = .)
titles <- read_lines("data/titles")

# Step 2: Tokenize Plot Text and Calculate Relative Word Position
setwd("/Users/trentyu/Desktop/Messy Data Machine Learning/Assignment 5/data")
source("assignment5.R")
plot_words <- make_plot_words(plots = plots, titles = titles)
test_make_plot_words()

# Step 3: Identify Most Positionally Interesting Words
interesting_words <- make_interesting_words(plot_words = plot_words)
test_make_interesting_words()

# Step 4: Visualize Word Position and Frequency
library(ggplot2)

ggplot(interesting_words %>% arrange(desc(median_position)),
       aes(x = reorder(word, -median_position), y = median_position)) +
  geom_bar(stat = "identity", fill = "lightblue") +
  labs(x = "Word", y = "Median Position", title = "Words by Median Position") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme_minimal()

ggplot(interesting_words %>% arrange(desc(word_count)),
       aes(x = reorder(word, -word_count), y = word_count)) +
  geom_bar(stat = "identity", fill = "orange") +
  labs(x = "Word", y = "Number of Occurrences", title = "Words by Number of Occurrences") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme_minimal()

# Step 5: Aggregate Word Counts by Plot Deciles
word_decile_counts <- make_word_decile_counts(plot_words = plot_words)
test_make_word_decile_counts()

# Step 6: Visualize Word Frequency Across Plot Deciles
interesting_words <- interesting_words %>%
  mutate(color = ifelse(rank(desc(median_position)) <= 10, "blue", "red"))

merged_data <- word_decile_counts %>%
  inner_join(interesting_words, by = "word") %>%
  mutate(normalized_frequency = n / word_count)

ggplot(merged_data, aes(x = decile, y = normalized_frequency, color = color, group = word)) +
  geom_line() +
  scale_color_identity() +
  labs(x = "Decile", y = "Normalized Frequency", title = "Distribution of Words Over Deciles") +
  facet_wrap(~ word, ncol = 5) +
  theme_minimal() +
  theme(legend.position = "none", 
        strip.text = element_text(size = 10),
        plot.title = element_text(hjust = 0.5))

# Step 7: Generate Sentiment Scores Per Plot Decile
lexicon <- tidytext::get_sentiments("bing")
plots <- make_sentiments(plot_words = plot_words, lexicon = lexicon)
test_make_sentiments()

# Step 8: Build Logistic Regression Model to Predict Ending Type
modeling_data <- process_plots_for_modeling(plots = plots)
ending_model <- glm(is_happy_ending ~ .,
                    data = select(modeling_data, -story_number, -title),
                    family = "binomial")
test_process_plots_for_modeling()

# Step 9: Test Model on New Plot ("Enchanted")
my_plot <- tibble(text = c(
  "In the magical animated land of Andalasia, a young maiden named Giselle dreams of true love.",
  "Giselle imagines meeting her perfect prince, and her animal friends help her create a statue of him.",
  ... # (truncated for brevity)
))

my_plot_words <- make_plot_words(plots = my_plot, titles = "enchanted")
my_plot_sentiments <- make_sentiments(my_plot_words, lexicon = lexicon)
my_modeling_data <- process_plots_for_modeling(plots = my_plot_sentiments)
predict(ending_model, newdata = my_modeling_data, type = "response")

# Step 10: Generate Rewritten Sad Ending
my_rewritten_plot <- tibble(text = c(
  "In the magical land of Andalasia, a young maiden named Giselle dreams of finding true love, but is often lonely and misunderstood.",
  ... # (truncated for brevity)
))

my_rewritten_plot_words <- make_plot_words(plots = my_rewritten_plot, titles = "Enchanted - Sad Version")
my_rewritten_plot_sentiments <- make_sentiments(my_rewritten_plot_words, lexicon = lexicon)
my_rewritten_plot_sentiments %>% filter(decile == 10)
